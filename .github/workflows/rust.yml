name: Build iOS App

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios, aarch64-apple-ios-sim
  
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install Dioxus CLI via binstall
        run: cargo binstall dioxus-cli -y --force
        env: 
          GITHUB_TOKEN: ${{ secrets.SECRET_TOKEN }}       
          
      - name: Build for iOS
        run: dx bundle --platform ios --release --device true  --codesign false
        # env:
        #   CODE_SIGNING_ALLOWED: "no"
        #   CODE_SIGNING_REQUIRED: "no"
        #   CODE_SIGN_IDENTITY: ""
        #   PROVISIONING_PROFILE_SPECIFIER: ""
          
      # - name: Package for SideStore (IPA)
      #   run: |
      #     mkdir -p Payload
      #     cp -r target/dx/testapp/release/ios/Testapp.app Payload/
      #     zip -r Testapp.ipa Payload
      
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: testapp-sideload
          path: Testapp.ipa
